{% extends 'base.html' %}
{% load static %}

{% block title %}Resume Assistant - Resume Screening Tool{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    .message-list {
        height: calc(100% - 100px);
        overflow-y: auto;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .message {
        max-width: 80%;
        padding: 12px 18px;
        margin-bottom: 15px;
        border-radius: 15px;
        position: relative;
    }
    
    .user-message {
        background-color: rgb(12, 36, 52);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }
    
    .assistant-message {
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }
    
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }
    
    .chat-input-container {
        margin-top: 15px;
    }
    
    /* Fix for chat textarea - Adding better contrast */
    .chat-input-container textarea {
        background-color: rgba(33, 37, 41, 0.9);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Style for placeholder text */
    .chat-input-container textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Focus state */
    .chat-input-container textarea:focus {
        background-color: rgba(33, 37, 41, 0.95);
        color: white;
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
    }
    
    .typing-indicator {
        display: none;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        margin-bottom: 15px;
    }
    
    .typing-indicator span {
        height: 10px;
        width: 10px;
        margin: 0 1px;
        background-color: #9E9EA1;
        display: inline-block;
        border-radius: 50%;
        opacity: 0.4;
        animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    /* Style for navigation links in chat messages */
    .assistant-message a {
        color: #4db6ff;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.2s ease;
    }
    
    .assistant-message a:hover {
        color: #7fcfff;
        text-decoration: underline;
    }
    
    /* Quick navigation buttons */
    .quick-nav-btn {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 8px 15px;
        margin: 5px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    
    .quick-nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    .quick-nav-btn i {
        margin-right: 5px;
    }
    
    @keyframes typing {
        0% {
            opacity: 0.4;
            transform: translateY(0);
        }
        50% {
            opacity: 1;
            transform: translateY(-5px);
        }
        100% {
            opacity: 0.4;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="glass-card p-4">
                <h2 class="text-center mb-4">Resume Assistant</h2>
                <p class="text-center text-white-50 mb-4">Ask me anything about the Resume Screening Tool or where to find features.</p>
                
                <div class="mb-3 text-center">
                    <span id="status-indicator" class="badge bg-success">NLP-Powered Navigation Assistant</span>
                    {% if chat_history %}
                    <form method="post" action="{% url 'clear_chat_history' %}" class="d-inline ml-2" onsubmit="return confirm('Are you sure you want to clear your chat history?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">Clear History</button>
                    </form>
                    {% endif %}
                </div>
                
                <!-- Quick navigation buttons -->
                <div class="mb-4 text-center">
                    <button class="quick-nav-btn" data-route="/upload/"><i class="fas fa-upload"></i> Upload Resume</button>
                    <button class="quick-nav-btn" data-route="/dashboard/"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                    <button class="quick-nav-btn" data-route="/profile/"><i class="fas fa-user"></i> Profile</button>
                    <button class="quick-nav-btn" data-route="/pricing/"><i class="fas fa-tags"></i> Pricing</button>
                </div>
                
                <div class="chat-container">
                    <div class="message-list" id="message-list">
                        {% if chat_history %}
                            {% for message in chat_history %}
                                <div class="message {% if message.is_user %}user-message{% else %}assistant-message{% endif %}">
                                    {% if message.is_user %}
                                        {{ message.message|linebreaks }}
                                    {% else %}
                                        {{ message.message|safe|linebreaks }}
                                    {% endif %}
                                    <div class="message-time">{{ message.created_at|time:"h:i A" }}</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="message assistant-message">
                                Hello! I'm your resume assistant for the Resume Screening Tool. I can help you navigate to different sections of the application or answer questions. What would you like to do today?
                                <div class="message-time">Now</div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    
                    <div class="chat-input-container">
                        <form id="chat-form" method="post">
                            {% csrf_token %}
                            <div class="input-group">
                                {{ chat_form.message }}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageList = document.getElementById('message-list');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatForm = document.getElementById('chat-form');
        const statusIndicator = document.getElementById('status-indicator');
        const quickNavButtons = document.querySelectorAll('.quick-nav-btn');
        
        // Function to scroll to bottom of message list
        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // Call initially to scroll to bottom
        scrollToBottom();
        
        // Process message content to make links clickable - with error handling
        function processMessageLinks(content) {
            try {
                // Check if content is a string
                if (typeof content !== 'string') {
                    console.error('Content is not a string:', content);
                    return String(content);
                }
                
                // Match markdown style links [text](url)
                const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
                return content.replace(linkRegex, function(match, text, url) {
                    // Ensure the URL is valid
                    if (!url || typeof url !== 'string') {
                        return match; // return the original if the URL is invalid
                    }
                    return `<a href="${url}" class="chat-link">${text}</a>`;
                });
            } catch (error) {
                console.error('Error processing links:', error);
                return content; // Return the original content if there's an error
            }
        }
        
        // Function to add assistant message
        function addAssistantMessage(message) {
            try {
                // Process links in the message
                const processedMessage = processMessageLinks(message);
                
                // Create the message element
                const assistantMessageElement = document.createElement('div');
                assistantMessageElement.className = 'message assistant-message';
                assistantMessageElement.innerHTML = `
                    ${processedMessage.replace(/\n/g, '<br>')}
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                messageList.appendChild(assistantMessageElement);
                
                // Add click handlers to any links
                addLinkClickHandlers(assistantMessageElement);
                
                scrollToBottom();
            } catch (error) {
                console.error('Error adding assistant message:', error);
                // Add a basic error message if we can't add the fancy one
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message assistant-message';
                errorMessage.textContent = "Sorry, I encountered an error displaying my response.";
                messageList.appendChild(errorMessage);
                scrollToBottom();
            }
        }
        
        // Function to handle clicks on chat links
        function addLinkClickHandlers(element) {
            try {
                const links = element.querySelectorAll('a.chat-link');
                links.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const href = this.getAttribute('href');
                        if (href) {
                            // Navigate to the link
                            window.location.href = href;
                        }
                    });
                });
            } catch (error) {
                console.error('Error adding link handlers:', error);
            }
        }
        
        // Add click handlers to quick navigation buttons
        quickNavButtons.forEach(button => {
            button.addEventListener('click', function() {
                const route = this.getAttribute('data-route');
                if (route) {
                    window.location.href = route;
                }
            });
        });
        
        // Add link handlers to existing messages
        document.querySelectorAll('.assistant-message').forEach(addLinkClickHandlers);
        
        // Handle form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(chatForm);
                const userMessage = formData.get('message');
                
                if (!userMessage || !userMessage.trim()) {
                    return;
                }
                
                // Add user message to the chat
                const userMessageElement = document.createElement('div');
                userMessageElement.className = 'message user-message';
                userMessageElement.innerHTML = `
                    ${userMessage.replace(/\n/g, '<br>')}
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                messageList.appendChild(userMessageElement);
                
                // Clear input
                chatForm.reset();
                
                // Scroll to bottom
                scrollToBottom();
                
                // Show typing indicator
                typingIndicator.style.display = 'block';
                scrollToBottom();
                
                // Simple error handling for the fetch
                let fetchTimeoutId = setTimeout(() => {
                    // Handle timeout after 15 seconds
                    typingIndicator.style.display = 'none';
                    addAssistantMessage("I'm sorry, the request is taking too long. Please try again later.");
                }, 15000);
                
                // Add small delay to simulate processing time
                setTimeout(function() {
                    // Send message to server
                    fetch('{% url "chat_message_api" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => {
                        clearTimeout(fetchTimeoutId);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Hide typing indicator
                        typingIndicator.style.display = 'none';
                        
                        if (data.error) {
                            console.error('Server reported error:', data.error);
                        }
                        
                        // Get the message from the data
                        const message = data.message || "I'm sorry, I couldn't process that request properly.";
                        
                        // Process the message for links
                        const processedMessage = processMessageLinks(message);
                        
                        // Add assistant response to the chat
                        const assistantMessageElement = document.createElement('div');
                        assistantMessageElement.className = 'message assistant-message';
                        assistantMessageElement.innerHTML = `
                            ${processedMessage.replace(/\n/g, '<br>')}
                            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        `;
                        messageList.appendChild(assistantMessageElement);
                        
                        // Add click handlers to any links
                        addLinkClickHandlers(assistantMessageElement);
                        
                        // Scroll to bottom
                        scrollToBottom();
                        
                        // Check if we need to automatically navigate
                        if (data.navigation && data.destination) {
                            // Add a small delay then navigate
                            setTimeout(() => {
                                window.location.href = data.destination;
                            }, 1500);
                            
                            // Show a navigation message
                            const navMessage = document.createElement('div');
                            navMessage.className = 'message assistant-message';
                            navMessage.innerHTML = `
                                <i class="fas fa-circle-notch fa-spin"></i> Navigating to requested page...
                                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            `;
                            messageList.appendChild(navMessage);
                            scrollToBottom();
                        }
                    })
                    .catch(error => {
                        clearTimeout(fetchTimeoutId);
                        
                        // Hide typing indicator
                        typingIndicator.style.display = 'none';
                        
                        console.error('Error:', error);
                        
                        // Add error message
                        const errorMessageElement = document.createElement('div');
                        errorMessageElement.className = 'message assistant-message';
                        errorMessageElement.innerHTML = `
                            Sorry, I encountered an error processing your request. Please try again with a simpler question or navigate using the buttons above.
                            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        `;
                        messageList.appendChild(errorMessageElement);
                        
                        // Scroll to bottom
                        scrollToBottom();
                    });
                }, 500); // 500ms delay for typing simulation
            } catch (error) {
                console.error('Error in form submission:', error);
                
                // Hide typing indicator if visible
                typingIndicator.style.display = 'none';
                
                // Show a generic error message
                const errorMessageElement = document.createElement('div');
                errorMessageElement.className = 'message assistant-message';
                errorMessageElement.textContent = "Sorry, something went wrong. Please try again.";
                messageList.appendChild(errorMessageElement);
                
                // Scroll to bottom
                scrollToBottom();
            }
        });
    });
</script>
{% endblock %} 
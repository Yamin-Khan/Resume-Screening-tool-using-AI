{% extends 'base.html' %}
{% load static %}
{% load screening_extras %}

{% block title %}Bulk Screening Results - Resume Screening Tool{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    <div class="container mx-auto">
        <div class="max-w-7xl mx-auto">
            <div class="glass-card p-8 rounded-xl">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-white">Screening Results</h1>
                    <div class="flex gap-4">
                        <a href="{% url 'export_bulk_results' bulk_id=bulk_screen.id %}" 
                           class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                            <i class="fas fa-download"></i>
                            Export Results
                        </a>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white/5 rounded-lg p-6">
                        <h3 class="text-gray-400 text-sm mb-2">Average Match Score</h3>
                        <div class="flex items-center">
                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                <div class="h-2.5 rounded-full bg-blue-500" style="width: {{ avg_match_score }}%"></div>
                            </div>
                            <span class="text-xl font-semibold text-blue-400">{{ avg_match_score|floatformat:1 }}%</span>
                        </div>
                    </div>
                    <div class="bg-white/5 rounded-lg p-6">
                        <h3 class="text-gray-400 text-sm mb-2">Average ATS Score</h3>
                        <div class="flex items-center">
                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                <div class="h-2.5 rounded-full bg-green-500" style="width: {{ avg_ats_score }}%"></div>
                            </div>
                            <span class="text-xl font-semibold text-green-400">{{ avg_ats_score|floatformat:1 }}%</span>
                        </div>
                    </div>
                    <div class="bg-white/5 rounded-lg p-6">
                        <h3 class="text-gray-400 text-sm mb-2">Top Candidates</h3>
                        <p class="text-2xl font-semibold text-white">{{ top_candidates|length }}</p>
                        <p class="text-sm text-gray-400">Candidates with match score â‰¥ 70%</p>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="bg-white/5 rounded-xl border border-white/20 overflow-hidden">
                    <div class="max-h-[600px] overflow-y-auto">
                        <table class="min-w-full divide-y divide-white/20">
                            <thead class="bg-white/10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rank</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Candidate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Predicted Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Skills</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Match Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ATS Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Resume Ranking</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Confidence</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/20">
                                {% for result in results %}
                                <tr class="hover:bg-white/10">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">{{ result.rank }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div>
                                                <p class="text-sm font-medium text-white">{{ result.resume.name }}</p>
                                                <p class="text-xs text-gray-400">{{ result.resume.email }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                                        <span class="px-2 py-1 rounded-full text-xs bg-orange-900/20 text-orange-400 border border-orange-800/30">
                                            {{ result.resume.predicted_role|default:"Analyzing..." }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                                        {{ result.resume.skills|truncatechars:30 }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                                <div class="h-2.5 rounded-full bg-blue-500" 
                                                     style="width: {{ result.match_score }}%"></div>
                                            </div>
                                            <span class="text-sm text-blue-400">
                                                {{ result.match_score|floatformat:1 }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                                <div class="h-2.5 rounded-full bg-green-500" 
                                                     style="width: {{ result.ats_score }}%"></div>
                                            </div>
                                            <span class="text-sm text-green-400">
                                                {{ result.ats_score|floatformat:1 }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                                <div class="h-2.5 rounded-full bg-purple-500" 
                                                     style="width: {{ result.resume.ranking|default:50 }}%"></div>
                                            </div>
                                            <span class="text-sm text-purple-400">
                                                {{ result.resume.ranking|default:"Analyzing..." }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                                                <div class="h-2.5 rounded-full bg-yellow-500" 
                                                     style="width: {{ result.resume.confidence_score|default:75 }}%"></div>
                                            </div>
                                            <span class="text-sm text-yellow-400">
                                                {{ result.resume.confidence_score|default:75|floatformat:1 }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                                        <button 
                                           class="text-blue-400 hover:text-blue-300 view-details-btn"
                                           data-result-id="{{ result.id }}">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Results Modal -->
<div id="analysis-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
    <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-600/30 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white modal-candidate-name">Resume Analysis</h3>
            <button class="text-gray-400 hover:text-white close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Candidate Info -->
        <div class="mb-6 p-4 bg-gray-700/30 rounded-lg border border-gray-600/30">
            <div class="flex flex-wrap gap-4">
                <div>
                    <h4 class="text-sm text-gray-400 mb-1">Candidate</h4>
                    <p class="text-white font-medium modal-name">Loading...</p>
                </div>
                <div>
                    <h4 class="text-sm text-gray-400 mb-1">Email</h4>
                    <p class="text-white modal-email">Loading...</p>
                </div>
                <div>
                    <h4 class="text-sm text-gray-400 mb-1">Phone</h4>
                    <p class="text-white modal-phone">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Score Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white/5 rounded-lg p-4">
                <h3 class="text-gray-400 text-sm mb-2">ATS Score</h3>
                <div class="flex items-center">
                    <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                        <div id="modal-ats-score-bar" class="h-2.5 rounded-full bg-blue-500" style="width: 0%"></div>
                    </div>
                    <span id="modal-ats-score-text" class="text-xl font-semibold text-blue-400">0%</span>
                </div>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
                <h3 class="text-gray-400 text-sm mb-2">Content Score</h3>
                <div class="flex items-center">
                    <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                        <div id="modal-content-score-bar" class="h-2.5 rounded-full bg-green-500" style="width: 0%"></div>
                    </div>
                    <span id="modal-content-score-text" class="text-xl font-semibold text-green-400">0%</span>
                </div>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
                <h3 class="text-gray-400 text-sm mb-2">Keywords Score</h3>
                <div class="flex items-center">
                    <div class="w-2/3 bg-gray-700 rounded-full h-2.5 mr-3">
                        <div id="modal-keyword-score-bar" class="h-2.5 rounded-full bg-purple-500" style="width: 0%"></div>
                    </div>
                    <span id="modal-keyword-score-text" class="text-xl font-semibold text-purple-400">0%</span>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Strengths -->
            <div class="bg-white/5 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    Strengths
                </h3>
                <ul id="modal-strengths-list" class="space-y-2 pl-6 list-disc text-gray-300">
                    <!-- Strengths will be populated here -->
                    <li>Loading strengths...</li>
                </ul>
            </div>

            <!-- Improvement Areas -->
            <div class="bg-white/5 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <i class="fas fa-exclamation-circle text-yellow-400 mr-2"></i>
                    Areas for Improvement
                </h3>
                <ul id="modal-improvements-list" class="space-y-2 pl-6 list-disc text-gray-300">
                    <!-- Improvement areas will be populated here -->
                    <li>Loading improvements...</li>
                </ul>
            </div>
            <div class="bg-white/5 rounded-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-400 mr-2"></i> Detailed Analysis
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <h4 class="text-gray-400 text-sm">Job Match Score</h4>
                            <div class="text-xl font-semibold text-blue-400" id="job-match-score">N/A</div>
                        </div>
                        <div class="w-1/2 bg-gray-700 rounded-full h-2.5">
                            <div id="job-match-score-bar" class="h-2.5 rounded-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <h4 class="text-gray-400 text-sm">Resume Ranking</h4>
                            <div class="text-xl font-semibold text-green-400" id="resume-ranking">N/A</div>
                        </div>
                        <div class="w-1/2 bg-gray-700 rounded-full h-2.5">
                            <div id="resume-ranking-bar" class="h-2.5 rounded-full bg-green-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <h4 class="text-gray-400 text-sm">Confidence Score</h4>
                            <div class="text-xl font-semibold text-purple-400" id="confidence-score">N/A</div>
                        </div>
                        <div class="w-1/2 bg-gray-700 rounded-full h-2.5">
                            <div id="confidence-score-bar" class="h-2.5 rounded-full bg-purple-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="flex-1">
                            <h4 class="text-gray-400 text-sm">Predicted Role</h4>
                            <div class="text-xl font-semibold text-orange-400" id="predicted-role">N/A</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Keywords -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                <i class="fas fa-key text-blue-400 mr-2"></i>
                Skills & Keywords
            </h3>
            <div class="bg-white/5 rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-gray-400 text-sm mb-2">Found Keywords</h4>
                        <div id="modal-found-keywords" class="flex flex-wrap gap-2">
                            <!-- Found keywords will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-gray-400 text-sm mb-2">Missing Keywords</h4>
                        <div id="modal-missing-keywords" class="flex flex-wrap gap-2">
                            <!-- Missing keywords will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Experience Analysis -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                <i class="fas fa-briefcase text-purple-400 mr-2"></i>
                Experience Analysis
            </h3>
            <div class="bg-white/5 rounded-lg p-4">
                <ul id="modal-experiences" class="space-y-2 pl-6 list-disc text-gray-300">
                    <!-- Experience analysis will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Additional API Data -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                <i class="fas fa-chart-bar text-blue-400 mr-2"></i>
                Additional Insights
            </h3>
            <div class="bg-white/5 rounded-lg p-4">
                <ul id="modal-api-data" class="space-y-2 pl-6 list-disc text-gray-300">
                    <!-- Additional API data will be populated here -->
                </ul>
            </div>
        </div>
        
        <div class="flex justify-end gap-4">
            <button id="modal-download-report" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                <i class="fas fa-download"></i>
                Download Report
            </button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg close-modal">Close</button>
        </div>
    </div>
</div>

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
</style>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('analysis-modal');
        const closeModal = document.querySelectorAll('.close-modal');
        const viewDetailsBtns = document.querySelectorAll('.view-details-btn');
        
        // Close modal
        closeModal.forEach(btn => {
            btn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            });
        });
        
        // Close modal when clicking outside of it
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        });
        
        // View details buttons
        viewDetailsBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const resultId = this.getAttribute('data-result-id');
                if (resultId) {
                    fetchResumeDetails(resultId);
                } else {
                    console.error('No result ID found for this button');
                }
            });
        });
        
        // Function to fetch resume details from API
        function fetchResumeDetails(resultId) {
            // Show loading state in modal
            document.querySelector('.modal-candidate-name').textContent = 'Loading...';
            document.querySelector('.modal-name').textContent = 'Loading...';
            document.querySelector('.modal-email').textContent = 'Loading...';
            document.querySelector('.modal-phone').textContent = 'Loading...';
            document.getElementById('modal-strengths-list').innerHTML = '<li>Loading strengths...</li>';
            document.getElementById('modal-improvements-list').innerHTML = '<li>Loading improvements...</li>';
            document.getElementById('modal-experiences').innerHTML = '<li>Loading experience...</li>';
            document.getElementById('modal-api-data').innerHTML = '<li>Loading additional data...</li>';
            document.getElementById('modal-found-keywords').innerHTML = '';
            document.getElementById('modal-missing-keywords').innerHTML = '';
            
            // Show modal
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Get CSRF token
            const csrfToken = getCookie('csrftoken');
            if (!csrfToken) {
                console.error('CSRF token not found');
                return;
            }
            
            // Fetch data from API
            fetch(`/business/api/resume-result/${resultId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resume data:', data);
                updateModalContent(data);
            })
            .catch(error => {
                console.error('Error fetching resume details:', error);
                document.getElementById('modal-strengths-list').innerHTML = 
                    `<li class="text-red-400">Error loading data: ${error.message}</li>`;
                document.querySelector('.modal-candidate-name').textContent = 'Error Loading Data';
            });
        }
        
        // Function to update modal content with fetched data
        function updateModalContent(data) {
            if (!data || !data.resume) {
                console.error('Invalid data received:', data);
                return;
            }

            // Update candidate info
            document.querySelector('.modal-candidate-name').textContent = `Resume Analysis: ${data.resume.name || 'Unknown'}`;
            document.querySelector('.modal-name').textContent = data.resume.name || 'Not available';
            document.querySelector('.modal-email').textContent = data.resume.email || 'Not available';
            document.querySelector('.modal-phone').textContent = data.resume.phone || 'Not available';
            
            // Update scores with fallback values
            const scores = data.scores || {};
            document.getElementById('modal-ats-score-bar').style.width = `${scores.ats_score || 0}%`;
            document.getElementById('modal-ats-score-text').textContent = `${(scores.ats_score || 0).toFixed(1)}%`;
            
            document.getElementById('modal-content-score-bar').style.width = `${scores.content_score || 0}%`;
            document.getElementById('modal-content-score-text').textContent = `${(scores.content_score || 0).toFixed(1)}%`;
            
            document.getElementById('modal-keyword-score-bar').style.width = `${scores.keyword_score || 0}%`;
            document.getElementById('modal-keyword-score-text').textContent = `${(scores.keyword_score || 0).toFixed(1)}%`;
            
            // Update strengths
            const strengths = data.analysis?.strengths || [];
            let strengthsHtml = strengths.length > 0 
                ? strengths.map(strength => `<li>${strength}</li>`).join('')
                : '<li>No specific strengths identified</li>';
            document.getElementById('modal-strengths-list').innerHTML = strengthsHtml;
            
            // Update weaknesses
            const weaknesses = data.analysis?.weaknesses || [];
            let weaknessesHtml = weaknesses.length > 0
                ? weaknesses.map(weakness => `<li>${weakness}</li>`).join('')
                : '<li>No specific improvements identified</li>';
            document.getElementById('modal-improvements-list').innerHTML = weaknessesHtml;
            
            // Update keywords
            const foundSkills = data.analysis?.found_skills || [];
            let foundKeywordsHtml = foundSkills.length > 0
                ? foundSkills.map(skill => `<span class="px-3 py-1 bg-green-900/30 text-green-300 rounded-lg text-sm border border-green-800/30">${skill}</span>`).join('')
                : '<span class="text-gray-400">No matching skills found</span>';
            document.getElementById('modal-found-keywords').innerHTML = foundKeywordsHtml;
            
            const missingSkills = data.analysis?.missing_skills || [];
            let missingKeywordsHtml = missingSkills.length > 0
                ? missingSkills.map(skill => `<span class="px-3 py-1 bg-red-900/30 text-red-300 rounded-lg text-sm border border-red-800/30">${skill}</span>`).join('')
                : '<span class="text-gray-400">All required skills found</span>';
            document.getElementById('modal-missing-keywords').innerHTML = missingKeywordsHtml;
            
            // Update experience
            const experiences = data.analysis?.experience || [];
            let experienceHtml = experiences.length > 0
                ? experiences.map(exp => `<li>${exp}</li>`).join('')
                : '<li>No detailed experience information available</li>';
            document.getElementById('modal-experiences').innerHTML = experienceHtml;
            
            // Update additional insights
            let apiDataHtml = '';
            apiDataHtml += `<li>Match Score: <span class="text-blue-400 font-medium">${(scores.match_score || 0).toFixed(1)}%</span></li>`;
            apiDataHtml += `<li>Recommendation: <span class="text-gray-300">${data.analysis?.recommendation || 'No recommendation available'}</span></li>`;
            
            // Add predicted role if available
            if (data.ai_analysis?.predicted_role) {
                apiDataHtml += `<li>Predicted Role: <span class="text-orange-400 font-medium">${data.ai_analysis.predicted_role}</span></li>`;
            }
            
            // Add confidence score if available
            if (data.ai_analysis?.confidence_score) {
                apiDataHtml += `<li>Confidence Score: <span class="text-purple-400 font-medium">${data.ai_analysis.confidence_score}%</span></li>`;
            }
            
            document.getElementById('modal-api-data').innerHTML = apiDataHtml;
            
            // Store data for download
            currentResumeData = data;
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Store the current resume data for download
        let currentResumeData = null;
        
        // Download report button handler
        document.getElementById('modal-download-report').addEventListener('click', function() {
            if (!currentResumeData) {
                alert('No analysis results available to download');
                return;
            }
            
            const candidateName = currentResumeData.resume?.name || 'Unknown';
            const report = `
RESUME ANALYSIS REPORT FOR ${candidateName.toUpperCase()}
=============================================

SCORES
------
Match Score: ${(currentResumeData.scores?.match_score || 0).toFixed(1)}%
ATS Score: ${(currentResumeData.scores?.ats_score || 0).toFixed(1)}%
Content Score: ${(currentResumeData.scores?.content_score || 0).toFixed(1)}%
Keyword Score: ${(currentResumeData.scores?.keyword_score || 0).toFixed(1)}%

STRENGTHS
---------
${(currentResumeData.analysis?.strengths || ['No strengths identified']).join('\n')}

AREAS FOR IMPROVEMENT
--------------------
${(currentResumeData.analysis?.weaknesses || ['No improvements identified']).join('\n')}

SKILLS ANALYSIS
--------------
Found Skills:
${(currentResumeData.analysis?.found_skills || ['No skills found']).join(', ')}

Missing Skills:
${(currentResumeData.analysis?.missing_skills || ['No missing skills']).join(', ')}

EXPERIENCE
---------
${(currentResumeData.analysis?.experience || ['No experience details available']).join('\n')}

RECOMMENDATION
------------
${currentResumeData.analysis?.recommendation || 'No recommendation available'}
            `;
            
            // Create a Blob with the report text
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link and click it to download the file
            const a = document.createElement('a');
            a.href = url;
            a.download = `${candidateName.replace(/\s+/g, '_')}_resume_analysis.txt`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    });
</script>
{% endblock %}
{% endblock %} 